/*LCD Core 4.0, DB 3.2.1, UI 1.0*/function log(t,e){e&&console.warn(e),console.log("object"==typeof t?js(t):t)}function logg(t,e){t&&t.length?(e?console.groupCollapsed(t):console.group(t),logg.timer=logg.timer||[],logg.timer.push(Date.now())):(logg.timer&&t&&log("["+(Date.now()-logg.timer.pop())/1e3+"]"),console.groupEnd())}function loggg(t,e){logg(t,1),e(),logg()}function assert(t,e,s=null){s=s?s+": ":"";var r=(t=js(t))==(e=js(e));return r?console.log("%c"+s+t,"color:green"):console.error(s+t+", expected: "+e),r}Object.assign(Object,{isObject:t=>t&&"object"==typeof t&&!Array.isArray(t),isEmpty:t=>0===Object.keys(t).length}),Object.assign(Function,{isFunction:t=>"function"==typeof t}),Object.assign(String,{isString:t=>"string"==typeof t,denull:t=>null==t?"":t+"",isEmpty:t=>null==t||0==(t+"").trim().length,nullify:t=>null==t||""==(t+"").trim()?null:t}),Object.assign(Array.prototype,{findValue:function(e){return this.findIndex(t=>t==e)},has:function(t){return-1<this.findValue(t)},pushIf:function(t,e){t&&this.push(void 0===e?t:e)}});const guid=()=>crypto.randomUUID(),wait=(t,e)=>setTimeout(e,t),priv=(e,...t)=>{t.forEach(t=>Object.defineProperty(e,t,{enumerable:!1}))},rnd=t=>Math.floor(Math.random()*Math.floor(t)),js=JSON.stringify,jscopy=t=>JSON.parse(js(t)),pojo=t=>clone(t,"toPojo"),clone=(t,s)=>{let r=Array.isArray(t)?[]:{};return each(t,(t,e)=>{Array.isArray(t)?r[e]=clone(t,s):Object.isObject(t)?r[e]=t[s]?t[s]():clone(t,s):Array.isArray(t)?r[e]=clone(t,s):r[e]=t}),r},qs=()=>{var t,e,s={};for([t,e]of new URLSearchParams(window.location.search).entries())s[t]=e;return s},each=(t,e)=>{let s;if(t)if(Array.isArray(t))for(var r=0;r<t.length&&!(s=e.call(t,t[r],r));r++);else for(var r in t)if(!Function.isFunction(t[r])&&(s=e.call(t,t[r],r)))break;return s};class Obj{on(t,e){return this["on"+t]=e,this}priv(...t){t.forEach(t=>Object.defineProperty(this,t,{enumerable:!1}))}}class ObjArray extends Array{on(t,e){return this["on"+t]=e,this}}class Storage{constructor(t){this.key=t}save(t){localStorage.setItem(this.key,js(t))}fetch(){var t=localStorage.getItem(this.key);return t&&JSON.parse(t)}erase(){localStorage.removeItem(this.key)}}class StorableObj extends Obj{constructor(t,e=0){super(),this._storage=new Storage(t||window.location),this.priv("_storage"),e?this.erase():this.fetch()}fetch(){var t=this._storage.fetch();this.mix(t)}mix(t){t&&Object.assign(this,t)}save(){this._storage.save(pojo(this))}erase(){this._storage.erase()}}class LocalDb{static open(t,e){t=new this(t);return t.open(),e&&t.notSetup()&&e(t),t}constructor(t){this.name=t,this._tables={},this._tpkfs={}}createTables(t){each(t,(t,e)=>{this.table(e,1)||this.createTable(e,t)})}createTable(t,e){var s=new this.constructor.Table(this,t,e);return this._tables[t]=s,this._tpkfs[t]=e,this.saveTables(),s}drop(){each(this._tables,(t,e)=>this.dropTable(e)),this.eraseTables()}dropTable(t){this.table(t).drop(),this._tables[t]=null,delete this._tables[t],delete this._tpkfs[t],this.saveTables()}insert(t){return this.table(t).insert()}insertOrUpdate(t){return this.table(t).insertOrUpdate()}select(t){return this.table(t).select()}update(t){return this.table(t).update()}delete(t){return this.table(t).delete()}notSetup(){return Object.isEmpty(this._tables)}setup(){}table(t,e){var s=this._tables[t];if(void 0!==s||e)return s;throw"Table "+t+" not defined"}key(t){return this.name+"."+t}open(){var t=LocalDb.fetch(this.key("tables"));return each(t,(t,e)=>(this._tables[e]=LocalDb.Table.open(this,e,t),null)),this}saveTables(){LocalDb.store(this.key("tables"),this._tpkfs)}eraseTables(){LocalDb.erase(this.key("tables"))}static store(t,e){localStorage.setItem(t,js(e))}static fetch(t){return JSON.parse(localStorage.getItem(t))}static erase(t){localStorage.removeItem(t)}}LocalDb.Table=class{static open(t,e,s){return new LocalDb.Table(t,e,s).open()}constructor(t,e,s){this.name=e,this._db=t,this._pkf=s,this._pks=[],this._npk=0,this._key=t.name+".table."+e,priv(this,"_db","_pkf","_pks","_npk","_key")}open(){var t=this.fetchStats();return t&&(this._pks=t.pks,this._npk=t.npk),this}drop(){this._pks.forEach(t=>this.eraseRow(t)),this.eraseStats()}select(){return{where:t=>this.selectByWhere(t),pk:t=>this.selectByPk(t)}}selectByWhere(t){var e=this.selectAll();return e=t?e.filter(t):e}selectByPk(t,e){t=LocalDb.fetch(this.key(t));if(void 0===t&&e)throw"Row not found";return t}selectAll(){var e=[];return this._pks.forEach(t=>e.push(LocalDb.fetch(this.key(t)))),e}delete(){return{where:t=>this.deleteByWhere(t),pk:t=>this.deleteByPk(t)}}deleteByWhere(t){var e,t=this.selectByWhere(t);return t.each(t=>{e=t[this._pkf],this.deletePk(e)}),this.saveStats(),t.length}deleteByPk(t){this.selectByPk(t,1),this.deletePk(t),this.saveStats()}deletePk(e){this.eraseRow(e),this._pks=this._pks.filter(t=>t!=e)}insertOrUpdate(){return{values:t=>this.insertOrUpdateByValues(t)}}insert(){return{values:t=>this.insertByValues(t)}}update(){return{set:e=>({where:t=>this.updateByWhere(e,t),pk:t=>this.updateByPk(e,t)}),values:t=>this.updateByValues(t)}}insertOrUpdateByValues(t){return t[this._pkf]?this.updateByValues(t):this.insertByValues(t)}insertByValues(t){var e;return(Array.isArray(t)?t:[t]).forEach(t=>{e=this.insertRec(t)}),e}insertRec(t){t=jscopy(t);return t[this._pkf]=++this._npk,this._pks.push(this._npk),this.saveStats(),this.save(t),t}updateByWhere(t,e){e=this.selectByWhere(e);return this.updateRows(e,t),e.length}updateByPk(t,e){e=[this.selectByPk(e,1)];return this.updateRows(e,t)}updateRows(t,e){var s;return t.forEach(t=>{e(t),this.save(t),s=t}),s}updateByValues(t){var e=t[this._pkf];if(void 0===e)throw"PK undefined";e=this.selectByPk(e,1),e=Object.assign(e,t);return this.save(e),e}key(t){return this._key+"."+t}save(t){LocalDb.store(this.key(t[this._pkf]),t)}saveStats(){LocalDb.store(this.key("stats"),{npk:this._npk,pks:this._pks})}fetchStats(){return LocalDb.fetch(this.key("stats"))}eraseStats(){LocalDb.erase(this.key("stats"))}eraseRow(t){LocalDb.erase(this.key(t))}};class LocalClient extends Obj{onworking(t){}constructor(t){super(),this.server=t}async ajax_get(t,e){return Number.isInteger(e)&&(e={id:e}),this.ajax("GET",t,e)}async ajax_post(t,e){return this.ajax("POST",t,e)}async ajax(t,e,s){this.onworking(1),wait(1);try{var r=s&&jscopy(s),i=JSON.parse(this.server.process(e,r));if(200==i[0])return i[1];if(419==i[0]&&this.onexpired)return this.onexpired();if(this.onerror)return this.onerror(i[1]);throw i[1]}catch(t){throw log(t),"Unknown Error"}}}class LocalResponse extends Array{static asOK(t){return void 0===t&&(t=null),js(new this(200,t))}static asOKOrNotFound(t){return t?this.asOK(t):this.asNotFound()}static asBadRequest(t="Bad Request"){return js(new this(400,t))}static asUnauthorized(t="Unauthorized"){return js(new this(401,t))}static asBadLogin(t="Bad Login"){return js(new this(401,t))}static asForbidden(t="Forbidden"){return js(new this(403,t))}static asNotFound(t="Not Found"){return js(new this(404,t))}static asExpired(t="Session Expired"){return js(new this(419,t))}static asServerError(t="Internal Server Error"){return js(new this(500,t))}}class LocalSession{static open(t,e=30){return new this(t,e)}constructor(t,e=30){this.store=new LocalSessionStorage(t,e),this.data={},this.fetch()}fetch(){return this.data=this.store.fetch()||{},this.data}set(t,e){return this.data[t]=e,this.save(),this}get(t){return this.data[t]}save(){return this.store.save(this.data),this}erase(){return this.store.erase(),this.data={},this}}class LocalSessionStorage{constructor(t,e=null){this.key=t,this.minToExpire=e}save(t){var e=this.minToExpire?Date.now()+6e4*this.minToExpire:null;localStorage.setItem(this.key,js({obj:t,expires:e}))}fetch(){var t=JSON.parse(localStorage.getItem(this.key));return t?.expires&&(Date.now()>t.expires?(this.erase(),t=null):this.save(t.obj)),t?.obj}erase(){localStorage.removeItem(this.key)}}function resolve(t,e,s=null){if(e)for(var r,i=e.split("."),a=0;a<i.length;a++)null!=t&&(t=1==(r=i[a].split("()")).length?t[r[0]]:t[r[0]]());return t=s&&String.isString(t)?t.toUpperCase():t}Array.prototype.sortBy=function(a){var o=[];if(a){a=a.split(",");for(var t=0;t<a.length;t++)a[t]=a[t].trim(),"-"==a[t].substr(0,1)?(a[t]=a[t].substr(1),o.push(-1)):o.push(1);[].sort.call(this,function(t,e){for(var s,r,i=0;i<a.length;i++){if(s=resolve(t,a[i],1),(r=resolve(e,a[i],1))<s)return+o[i];if(s<r)return-1*o[i]}return 0})}return this};const $=document.querySelector.bind(document),$$=document.querySelectorAll.bind(document);Node.prototype.on=window.on=function(t,e,s){return this._events=this._events||{},this._events[t]=this._events[t]||[],this._events[t].push(e),this.addEventListener(t,e,s),this},Node.prototype.on_once=window.on_once=function(t,e){return this.addEventListener(t,e,{once:!0}),this},NodeList.prototype.on=function(s,r,i){return this.forEach((t,e)=>{t.on(s,r,i)}),this},HTMLElement.prototype.$=HTMLElement.prototype.querySelector,HTMLElement.prototype.$$=HTMLElement.prototype.querySelectorAll;class Dialog extends Obj{constructor(t,e){super(),this.$dialog=document.createElement("dialog").on("close",()=>this.$dialog_onclose()),this.$dialog.className="dialog",this.$dialog.tabIndex=1,this.$dialog.innerHTML="<form method='dialog'><div class='dtitle'>"+(e||"")+"</div><div class='dbody'></div><div class='dact'></div></form>",$("body").append(this.$dialog),this.$body=this.$dialog.$(".dbody"),this.$actions=this.$dialog.$(".dact"),t.forEach(t=>{let e=t.toLowerCase();var s=document.createElement("button").on("click",t=>this.onclick("on"+e));s.innerText=t,s.className=e,s.value=t,this.$actions.append(s)})}show(){return this.$dialog.classList.add("dshow"),this.$dialog.showModal(),window._events.blur&&window._events.blur[0](),this}onclick(t){this[t]&&this[t]()}$dialog_onclose(){this.$dialog.classList.remove("dshow"),document.activeElement.blur(),window._events.focus&&window._events.focus[0]()}static loadSelect(s,t){t.forEach((t,e)=>s[e]=new Option(t,e))}static asMsg(t,e,s){t=new this(t,s);return t.$body.innerHTML='<div class="msg">'+e+"</div>",t}static asMsgOk(t,e){return this.asMsg(["OK"],t,e)}static asMsgOkCancel(t,e){return this.asMsg(["OK","Cancel"],t,e)}static withBody(t,e,s){t=new this(t,e);return t.$body.append(s),t}static asSaveCancel(t,e){return this.withBody(["Save","Cancel"],t,e)}}